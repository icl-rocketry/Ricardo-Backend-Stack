home.{$RICARDO_BACKEND_DOMAIN} {
    # Use self-signed certificates
    tls internal

    # Serve index file
    root * /www/html
    file_server
}

backend.{$RICARDO_BACKEND_DOMAIN} {
    # Use self-signed certificates
    tls internal

    # Proxy Flask, Socket.IO, and Websockets
    reverse_proxy ricardo-backend:1337
    reverse_proxy /socket.io/* ricardo-backend:1337
    reverse_proxy /ws/* ricardo-backend:1338
}

command.{$RICARDO_BACKEND_DOMAIN} {
    # Use self-signed certificates
    tls internal

    # Proxy Command Server
    reverse_proxy ricardo-commandserver:1339
}

grafana.{$RICARDO_BACKEND_DOMAIN} {
    # Add handler for Websockets
    @ws {
        header Upgrade websocket
        header Connection *Upgrade*
    }

    # Use self-signed certificates
    tls internal

    # Proxy Grafana (and its websocket connections)
    reverse_proxy grafana:3000
    reverse_proxy /api/live/* @ws grafana:3000
}

questdb.{$RICARDO_BACKEND_DOMAIN} {
    # Use self-signed certificates
    tls internal

    # Proxy QuestDB
    reverse_proxy questdb:9000
}
